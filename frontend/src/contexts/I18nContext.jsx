import { createContext, useContext, useEffect, useState } from 'react'

export const I18nContext = createContext({ t: (k)=>k, lang: 'es', setLang: ()=>{} })

export const useI18n = () => {
  const context = useContext(I18nContext)
  if (!context) {
    throw new Error('useI18n must be used within I18nProvider')
  }
  return context
}

const dict = {
  es: {
    language: 'Idioma', darkMode: 'Modo oscuro', lightMode: 'Modo claro', dashboard: 'Dashboard', prediction: 'Predicción', about: 'Acerca', history: 'Historial', contact: 'Contacto', login: 'Ingresar', logout: 'Salir',
    home: 'Inicio',
    search: 'Buscar',
    no_results: 'Sin resultados',
    accessibility_menu: 'Accesibilidad',
    accessibility_dark_mode: 'Modo oscuro',
    aria_toggle_dark_mode: 'Alternar modo oscuro',
    accessibility_high_contrast: 'Alto contraste',
    accessibility_font_friendly: 'Fuente amigable',
    accessibility_text_size: 'Tamaño de texto',
    accessibility_reading_comfort: 'Comodidad de lectura',
    accessibility_pause_animations: 'Pausar animaciones',
    accessibility_tts: 'Texto a voz',
    accessibility_tts_test: 'Hola, soy el sistema de texto a voz de EduPredict. Puedo leer cualquier contenido en voz alta para ayudarte.',
    accessibility_tts_play: 'Reproducir',
    accessibility_tts_stop: 'Detener',
    accessibility_learn_more: 'Más sobre accesibilidad',
    accessibility_reset: 'Restablecer Preferencias',
    accessibility_features_title: 'Funciones Disponibles',
    accessibility_shortcuts_title: 'Atajos de Teclado',
    accessibility_active: 'Activo',
    announce_high_contrast_activated: 'Alto contraste activado',
    announce_high_contrast_deactivated: 'Alto contraste desactivado',
  accessibility_feature_high_contrast_title: 'Alto Contraste',
  accessibility_feature_high_contrast_desc: 'Mejora la visibilidad con un contraste mínimo de 4.5:1 (WCAG)',
  accessibility_feature_text_size_title: 'Ajuste de Texto',
  accessibility_feature_text_size_desc: 'Aumenta el tamaño del texto para mayor legibilidad',
  accessibility_feature_reading_title: 'Modo Lectura',
  accessibility_feature_reading_desc: 'Mejora el espaciado y formato para lectura prolongada',
  accessibility_feature_pause_title: 'Pausar Animaciones',
  accessibility_feature_pause_desc: 'Desactiva animaciones y transiciones',
  accessibility_feature_tts_title: 'Texto a Voz (TTS)',
  accessibility_feature_tts_desc: 'Lee el contenido en voz alta con la API Web Speech',
  shortcut_open_menu: 'Abrir menú de accesibilidad',
  shortcut_tab: 'Navegar entre elementos',
  shortcut_activate: 'Activar elemento',
  shortcut_close: 'Cerrar modales/menús',
  access_denied: 'Acceso denegado',
  access_admin_required: 'Necesitas permisos de administrador para acceder a esta sección.',
  admin_create_user: 'Crear usuario / administrador',
  label_name: 'Nombre',
  label_email: 'Email',
  label_password: 'Contraseña',
  label_role: 'Rol',
  creating: 'Creando...',
  create_user: 'Crear usuario',
    home_title: 'Sistema Web de Predicción del Rendimiento Académico',
    home_subtitle: 'IA que analiza notas, hábitos de estudio y asistencia para anticipar riesgos de deserción estudiantil y facilitar intervenciones tempranas.',
    cta_dashboard: 'Ir al dashboard',
    cta_learn_more: 'Conocer más',
    offers_title: 'Qué ofrecemos',
    feature_1_title: 'Predicción Inteligente',
    feature_1_desc: 'Modelos que anticipan riesgos y apoyan decisiones.',
    feature_2_title: 'Visualización de Datos',
    feature_2_desc: 'Dashboards claros para supervisión y análisis.',
    feature_3_title: 'Privacidad',
    feature_3_desc: 'Datos anonimizados y uso responsable.',
    feature_4_title: 'Beneficios',
    feature_4_desc: 'Intervenciones tempranas para mejorar el rendimiento.',
    hero_card_title: 'Visión rápida',
    hero_card_subtitle: 'Interfaz simple con recomendaciones accionables y paneles claros para seguimiento.',
    hero_item_1: 'Estudiantes',
    hero_item_2: 'Predicciones',
    hero_item_3: 'Alertas',
    hero_item_4: 'Reportes'
    ,
    news_latest_title: 'Últimas mejoras',
    news_latest_desc: 'Optimización de carga inicial y mejora de accesibilidad (WCAG 2.2 AA).',
    news_new_title: 'Nuevas funciones',
    news_new_desc: 'Ayuda contextual accesible y rutas mejor definidas para el formulario.',
    news_next_title: 'Próximas versiones',
    news_next_desc: 'Historial de predicciones con exportación y panel de seguimiento.',
    // Dashboard translations
    dashboard_subtitle: 'Panel de control',
    dashboard_title: 'Tech Dashboard 2025',
    dashboard_welcome: 'Visión general de tus predicciones y estado del modelo. Bienvenido/a,',
    quick_prediction: 'Predicción Rápida',
    new_prediction: 'Nueva Predicción',
    prediction_hint: 'Usa punto decimal (2.4) para mayor precisión.',
    btn_calculate: 'Calcular Predicción',
    btn_processing: 'Procesando...',
    label_average: 'Promedio (0-10)',
    label_attendance: 'Asistencia %',
    label_study_hours: 'Horas de estudio (0-60)',
    label_trend: 'Tendencia académica',
    label_punctuality: 'Puntualidad %',
    label_habits: 'Hábitos (0-10)',
    summary_title: 'Resumen',
    stat_total: 'Total predicciones',
    stat_alerts: 'Alertas',
    stat_avg_score: 'Score promedio',
    stat_last_train: 'Último entrenamiento',
    stat_best_model: 'Mejor modelo (F1)',
    stat_helper_history: 'Historial acumulado',
    stat_helper_performance: 'Rendimiento global',
    stat_helper_detections: 'Detecciones tempranas',
    stat_no_model: 'Sin modelo',
    stat_pending: 'Pendiente',
    nav_history: 'Ver Historial Completo',
    chart_risk_high: 'Alto',
    chart_risk_medium: 'Medio',
    chart_risk_low: 'Bajo',
    msg_error: 'Error al realizar la predicción',
    // Prediction page translations
    pred_page_title: 'Predicción de Rendimiento',
    pred_page_subtitle: 'Predicción 2025',
    pred_page_desc: 'Ingresa tus datos académicos y hábitos. Usa punto decimal (2.4) para obtener mayor precisión.',
    mini_dash_title: 'Mini dashboard',
    mini_dash_desc: 'Métrica global, distribución de riesgo y estado del modelo',
    btn_run_prediction: 'Realizar predicción',
    btn_analyzing: 'Analizando...',
    best_model_label: 'Mejor modelo:',
    chart_risk_distribution: 'Distribución de riesgo',
    chart_global_metric: 'Métrica global',
    btn_generate_pdf: 'Generar PDF',
    btn_generating_pdf: 'Generando PDF...',
    btn_update_dashboard: 'Actualizar dashboard',
    toast_prediction_success: 'Predicción generada con éxito',
    toast_prediction_error: 'No pudimos procesar la predicción. Intenta nuevamente.',
    toast_stats_error: 'No pudimos cargar las estadísticas',
    toast_pdf_success: 'PDF generado',
    toast_pdf_error: 'No se pudo generar el PDF. Intenta nuevamente.',
    validation_promedio: 'El promedio debe estar entre 0 y 10 (usa punto decimal).',
    validation_asistencia: 'La asistencia debe estar entre 0 y 100.',
    validation_horas: 'Las horas de estudio deben ser 0 o más.',
    validation_tendencia: 'La tendencia debe estar entre -10 y 10.',
    validation_puntualidad: 'La puntualidad debe estar entre 0 y 100.',
    validation_habitos: 'Hábitos debe estar entre 0 y 10.',
    label_promedio_full: 'Promedio general (0-10)',
    label_asistencia_full: 'Asistencia (%)',
    label_horas_full: 'Horas de estudio semanales',
    label_tendencia_full: 'Tendencia académica (variación)',
    label_puntualidad_full: 'Puntualidad (%)',
    label_habitos_full: 'Hábitos de estudio (0-10)',
    // History page translations
    history_page_title: 'Historial de Predicciones',
    history_page_subtitle: 'Revisa el historial global de predicciones y tendencias',
    history_user_subtitle: 'Revisa tus predicciones anteriores y tu progreso',
    history_empty: 'No hay predicciones aún',
    history_empty_desc: 'Realiza tu primera predicción para comenzar a ver el historial',
    history_loading: 'Cargando...',
    history_unknown_date: 'Fecha desconocida',
    risk_label: 'Riesgo',
    btn_download_pdf: 'Descargar PDF',
    btn_make_prediction: 'Hacer una Predicción',
    btn_new_prediction: 'Nueva Predicción',
    card_average: 'Promedio',
    card_attendance: 'Asistencia',
    card_hours: 'Horas/sem',
    card_hours_study: 'Hrs. Estudio',
    card_trend: 'Tendencia',
    card_punctuality: 'Puntualidad',
    card_habits: 'Hábitos',
    card_date: 'Fecha',
    card_recommendation: 'Recomendación',
    // About page translations
    nav_about: 'Sobre Nosotros',
    about_subtitle: 'Innovación educativa impulsada por IA',
    about_title: 'Nuestro Propósito',
    about_description: 'EduPredict es una plataforma pionera en el análisis predictivo para la educación superior. Utilizamos datos académicos para estimar el rendimiento de los estudiantes y ofrecer recomendaciones personalizadas.',
    about_detail: 'Utilizamos algoritmos avanzados para detectar patrones académicos y potenciar el éxito estudiantil. Este proyecto institucional se enfoca en la mejora continua y el acompañamiento oportuno.',
    about_values: 'Nuestros Pilares',
    mission_title: 'Misión',
    mission_desc: 'Proporcionar herramientas tecnológicas que mejoren el rendimiento académico mediante predicciones basadas en datos.',
    vision_title: 'Visión',
    vision_desc: 'Ser la plataforma líder en análisis predictivo educativo, ayudando a instituciones y estudiantes a tomar decisiones informadas.',
    values_title: 'Valores',
    values_desc: 'Innovación, accesibilidad, privacidad, excelencia académica y compromiso con la educación inclusiva.',
    about_institution: 'Institución ULEAM',
    about_commitment: 'Proyecto desarrollado para fortalecer la toma de decisiones académicas y ofrecer un acompañamiento proactivo a nuestros estudiantes.',
    about_contact_btn: 'Contactar al equipo'
  },
  en: {
    language: 'Language', darkMode: 'Dark mode', lightMode: 'Light mode', dashboard: 'Dashboard', prediction: 'Prediction', about: 'About', history: 'History', contact: 'Contact', login: 'Login', logout: 'Logout',
    home: 'Home',
    search: 'Search',
    no_results: 'No results',
    accessibility_menu: 'Accessibility',
    accessibility_dark_mode: 'Dark mode',
    aria_toggle_dark_mode: 'Toggle dark mode',
    accessibility_high_contrast: 'High contrast',
    accessibility_font_friendly: 'Friendly font',
    accessibility_text_size: 'Text size',
    accessibility_reading_comfort: 'Reading comfort',
    accessibility_pause_animations: 'Pause animations',
    accessibility_tts: 'Text to speech',
    accessibility_tts_test: 'Hello, I am EduPredict text-to-speech. I can read content aloud to help you.',
    accessibility_tts_play: 'Play',
    accessibility_tts_stop: 'Stop',
    accessibility_learn_more: 'Learn more about accessibility',
    accessibility_reset: 'Reset preferences',
    accessibility_features_title: 'Available features',
    accessibility_shortcuts_title: 'Keyboard shortcuts',
    accessibility_active: 'Active',
    announce_high_contrast_activated: 'High contrast enabled',
    announce_high_contrast_deactivated: 'High contrast disabled',
  accessibility_feature_high_contrast_title: 'High Contrast',
  accessibility_feature_high_contrast_desc: 'Improves visibility with a minimum contrast of 4.5:1 (WCAG)',
  accessibility_feature_text_size_title: 'Text Adjustment',
  accessibility_feature_text_size_desc: 'Increase text size for better legibility',
  accessibility_feature_reading_title: 'Reading Mode',
  accessibility_feature_reading_desc: 'Improve spacing and formatting for prolonged reading',
  accessibility_feature_pause_title: 'Pause Animations',
  accessibility_feature_pause_desc: 'Disable animations and transitions',
  accessibility_feature_tts_title: 'Text to Speech (TTS)',
  accessibility_feature_tts_desc: 'Reads content aloud using the Web Speech API',
  shortcut_open_menu: 'Open accessibility menu',
  shortcut_tab: 'Navigate between elements',
  shortcut_activate: 'Activate element',
  shortcut_close: 'Close modals/menus',
  access_denied: 'Access denied',
  access_admin_required: 'You need administrator permissions to access this section.',
  admin_create_user: 'Create user / administrator',
  label_name: 'Name',
  label_email: 'Email',
  label_password: 'Password',
  label_role: 'Role',
  creating: 'Creating...',
  create_user: 'Create user',
    home_title: 'Academic Performance Prediction Web System',
    home_subtitle: 'AI that analyzes grades, study habits and attendance to anticipate dropout risks and enable early interventions.',
    cta_dashboard: 'Go to dashboard',
    cta_learn_more: 'Learn more',
    offers_title: 'What we offer',
    feature_1_title: 'Intelligent Prediction',
    feature_1_desc: 'Models that anticipate risks and support decisions.',
    feature_2_title: 'Data Visualization',
    feature_2_desc: 'Clear dashboards for monitoring and analysis.',
    feature_3_title: 'Privacy',
    feature_3_desc: 'Anonymized data and responsible use.',
    feature_4_title: 'Benefits',
    feature_4_desc: 'Early interventions to improve outcomes.',
    hero_card_title: 'Quick overview',
    hero_card_subtitle: 'Simple interface with actionable recommendations and clear panels for monitoring.',
    hero_item_1: 'Students',
    hero_item_2: 'Predictions',
    hero_item_3: 'Alerts',
    hero_item_4: 'Reports'
    ,
    news_latest_title: 'Latest improvements',
    news_latest_desc: 'Initial load optimization and accessibility improvements (WCAG 2.2 AA).',
    news_new_title: 'New features',
    news_new_desc: 'Accessible contextual help and better form routes.',
    news_next_title: 'Next releases',
    news_next_desc: 'Prediction history with export and monitoring panel.',
    // Dashboard translations
    dashboard_subtitle: 'Control Panel',
    dashboard_title: 'Tech Dashboard 2025',
    dashboard_welcome: 'Overview of your predictions and model status. Welcome,',
    quick_prediction: 'Quick Prediction',
    new_prediction: 'New Prediction',
    prediction_hint: 'Use decimal point (2.4) for better precision.',
    btn_calculate: 'Calculate Prediction',
    btn_processing: 'Processing...',
    label_average: 'Average Grade (0-10)',
    label_attendance: 'Attendance %',
    label_study_hours: 'Study Hours (0-60)',
    label_trend: 'Academic Trend',
    label_punctuality: 'Punctuality %',
    label_habits: 'Study Habits (0-10)',
    summary_title: 'Summary',
    stat_total: 'Total Predictions',
    stat_alerts: 'Alerts',
    stat_avg_score: 'Avg Score',
    stat_last_train: 'Last Training',
    stat_best_model: 'Best Model (F1)',
    stat_helper_history: 'Accumulated history',
    stat_helper_performance: 'Global performance',
    stat_helper_detections: 'Early detections',
    stat_no_model: 'No model',
    stat_pending: 'Pending',
    nav_history: 'View Full History',
    chart_risk_high: 'High',
    chart_risk_medium: 'Medium',
    chart_risk_low: 'Low',
    msg_error: 'Error performing prediction',
    // Prediction page translations
    pred_page_title: 'Performance Prediction',
    pred_page_subtitle: 'Prediction 2025',
    pred_page_desc: 'Enter your academic data and habits. Use decimal point (2.4) for better precision.',
    mini_dash_title: 'Mini Dashboard',
    mini_dash_desc: 'Global metrics, risk distribution and model status',
    btn_run_prediction: 'Run Prediction',
    btn_analyzing: 'Analyzing...',
    best_model_label: 'Best Model:',
    chart_risk_distribution: 'Risk Distribution',
    chart_global_metric: 'Global Metric',
    btn_generate_pdf: 'Generate PDF',
    btn_generating_pdf: 'Generating PDF...',
    btn_update_dashboard: 'Update Dashboard',
    toast_prediction_success: 'Prediction generated successfully',
    toast_prediction_error: 'Could not process prediction. Please try again.',
    toast_stats_error: 'Could not load statistics',
    toast_pdf_success: 'PDF generated',
    toast_pdf_error: 'Could not generate PDF. Please try again.',
    validation_promedio: 'Average must be between 0 and 10 (use decimal point).',
    validation_asistencia: 'Attendance must be between 0 and 100.',
    validation_horas: 'Study hours must be 0 or more.',
    validation_tendencia: 'Trend must be between -10 and 10.',
    validation_puntualidad: 'Punctuality must be between 0 and 100.',
    validation_habitos: 'Habits must be between 0 and 10.',
    label_promedio_full: 'Overall Average (0-10)',
    label_asistencia_full: 'Attendance (%)',
    label_horas_full: 'Weekly Study Hours',
    label_tendencia_full: 'Academic Trend (variation)',
    label_puntualidad_full: 'Punctuality (%)',
    label_habitos_full: 'Study Habits (0-10)',
    // History page translations
    history_page_title: 'Prediction History',
    history_page_subtitle: 'Review global history of predictions and trends',
    history_user_subtitle: 'Review your previous predictions and progress',
    history_empty: 'No predictions yet',
    history_empty_desc: 'Make your first prediction to start viewing your history',
    history_loading: 'Loading...',
    history_unknown_date: 'Unknown date',
    risk_label: 'Risk',
    btn_download_pdf: 'Download PDF',
    btn_make_prediction: 'Make a Prediction',
    btn_new_prediction: 'New Prediction',
    card_average: 'Average',
    card_attendance: 'Attendance',
    card_hours: 'Hours/week',
    card_hours_study: 'Study Hours',
    card_trend: 'Trend',
    card_punctuality: 'Punctuality',
    card_habits: 'Habits',
    card_date: 'Date',
    card_recommendation: 'Recommendation',
    // About page translations
    nav_about: 'About Us',
    about_subtitle: 'AI-driven educational innovation',
    about_title: 'Our Purpose',
    about_description: 'EduPredict is a pioneering platform in predictive analytics for higher education. We use academic data to estimate student performance and offer personalized recommendations.',
    about_detail: 'We use advanced algorithms to detect academic patterns and boost student success. This institutional project focuses on continuous improvement and timely support.',
    about_values: 'Our Pillars',
    mission_title: 'Mission',
    mission_desc: 'Provide technological tools that improve academic performance through data-driven predictions.',
    vision_title: 'Vision',
    vision_desc: 'To be the leading platform in educational predictive analytics, helping institutions and students make informed decisions.',
    values_title: 'Values',
    values_desc: 'Innovation, accessibility, privacy, academic excellence, and commitment to inclusive education.',
    about_institution: 'ULEAM Institution',
    about_commitment: 'Project developed to strengthen academic decision-making and provide proactive support to our students.',
    about_contact_btn: 'Contact the team'
  },
}

// Helper seguro para localStorage
const safeGetLang = () => {
  try {
    const stored = localStorage.getItem('lang')
    return stored && (stored === 'es' || stored === 'en') ? stored : 'es'
  } catch (e) {
    console.warn('[I18nContext] Error leyendo idioma de localStorage:', e)
    return 'es'
  }
}

const safeSetLang = (lang) => {
  try {
    localStorage.setItem('lang', lang)
  } catch (e) {
    console.warn('[I18nContext] Error guardando idioma:', e)
  }
}

export function I18nProvider({ children }){
  const [lang, setLang] = useState(() => safeGetLang())
  
  useEffect(() => {
    safeSetLang(lang)
  }, [lang])
  
  const t = (k) => {
    try {
      return (dict[lang] && dict[lang][k]) || k
    } catch (e) {
      console.warn('[I18nContext] Error traduciendo clave:', k, e)
      return k
    }
  }
  
  return (
    <I18nContext.Provider value={{ t, lang, setLang }}>
      {children}
    </I18nContext.Provider>
  )
}
